# Процесс фильтрации постов

## Общий поток
1. Выполнение задачи
2. Получение данных через VK API
3. Применение шаблонов фильтрации
4. Обработка и сохранение постов

## Подробное описание этапов

### 1. Создание и настройка задачи
- Пользователь создает задачу с указанием сообществ и шаблонов фильтров
- Шаблоны фильтров содержат ограничения на медиа-контент
- Каждый тип медиа (фото, видео и т.д.) имеет настройки мин/макс значений
- Специальные значения:
  - `-1`: Без ограничений (неограниченно)
  - `0`: Точное совпадение (должно быть ровно 0)
  - Положительные числа: Максимальное ограничение

### 2. Выполнение задачи
1. Планировщик запускает задачу
2. ScrapingService загружает конфигурацию задачи
3. Загружает все прикрепленные шаблоны фильтров
4. Обрабатывает каждое сообщество в задаче

### 3. Получение данных через VK API
1. Определяет ID сообщества/домен
2. Выполняет API-запрос с базовыми параметрами:
   - количество постов
   - смещение
   - тип фильтра
   - флаг расширенной информации

### 4. Процесс фильтрации постов
1. **Фильтр по глубине**
   - Фильтрует посты по временной метке
   - Использует параметр глубины задачи (в часах)

2. **Применение шаблонов фильтрации**
   - **ВАЖНО**: Пост сохраняется, если он соответствует ХОТЯ БЫ ОДНОМУ из прикрепленных шаблонов
   - Каждый шаблон применяется независимо
   - Если пост проходит фильтрацию хотя бы по одному шаблону, он считается подходящим

3. **Фильтр внешних ссылок**
   - Проверяет наличие внешних URL в тексте поста
   - Исключает специфичные для ВК упоминания/ссылки

4. **Фильтры медиа**
   - Обрабатывает каждый тип медиа отдельно
   - Применяет ограничения из текущего шаблона
   - Обрабатывает специальные случаи:
     - Без ограничений (-1)
     - Точное совпадение (0)
     - Максимальное ограничение (положительные числа)
   - Типы медиа:
     - Фотографии
     - Видео
     - Документы
     - Аудио

5. **Фильтр по тексту**
   - Ищет определенный текст, если указан

### 5. Обработка постов
1. Сохраняет отфильтрованные посты в базу данных
2. Обновляет существующие посты при необходимости
3. Скачивает медиа-контент, если включено в настройках
4. Обновляет статистику задачи

### Пример логики фильтрации
```
// Псевдокод
function filterPosts(posts, filterTemplates) {
    let filteredPosts = [];
    
    foreach (post in posts) {
        // Сначала проверяем глубину (это общее ограничение)
        if (!isWithinDepthLimit(post)) {
            continue;
        }
        
        // Проверяем по каждому шаблону независимо
        foreach (template in filterTemplates) {
            // Если пост соответствует хотя бы одному шаблону, добавляем его
            if (postMatchesTemplate(post, template)) {
                filteredPosts.push(post);
                break; // Переходим к следующему посту
            }
        }
    }
    
    return filteredPosts;
}

function postMatchesTemplate(post, template) {
    // Проверка внешних ссылок
    if (template.externalLinksAllowed === false && hasExternalLinks(post)) {
        return false;
    }
    
    // Проверка медиа-контента
    if (!checkMediaContent(post, template)) {
        return false;
    }
    
    // Проверка текста
    if (template.text && !post.text.includes(template.text)) {
        return false;
    }
    
    // Пост прошел все проверки для данного шаблона
    return true;
}
